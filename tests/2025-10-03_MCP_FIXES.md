# MCP Server Fixes & Documentation Updates

**Date**: October 3, 2025  
**Session**: Claude Desktop MCP Integration Testing & Bug Fixes

---

## Summary

Fixed two critical bugs preventing netkit-api from working as an MCP server with Claude Desktop, and added comprehensive documentation for end users.

---

## Bug 1: Docker Volume Mount - Tilde Expansion

### Problem
Docker doesn't expand `~` (tilde) in volume mount paths when specified in JSON configuration files.

**Error Message**:
```
docker: Error response from daemon: create ~/.ssh: "~/.ssh" includes invalid characters for a local volume name
```

### Root Cause
Claude Desktop config JSON passed `~/.ssh` directly to Docker, which requires absolute paths in this context.

### Solution
- Updated README.md to warn users about using absolute paths
- Added platform-specific examples:
  - macOS/Linux: `/Users/username/.ssh` or `/home/username/.ssh`
  - Windows: `C:/Users/username/.ssh` (forward slashes)

**Files Modified**: `README.md`

---

## Bug 2: Dockerfile ENTRYPOINT vs CMD

### Problem
MCP server was timing out after 60 seconds. HTTP API (port 8090) was starting instead of the MCP stdio server.

**Error Message**:
```
McpError: MCP error -32001: Request timed out
```

**Logs Showed**:
```
Starting netkit-api v2.0 on port 8090
INFO:     Uvicorn running on http://0.0.0.0:8090
```

### Root Cause
`Dockerfile` used `ENTRYPOINT` instead of `CMD`:

```dockerfile
ENTRYPOINT ["python", "/app/api/api.py"]  # WRONG
```

When running:
```bash
docker run ... flengure/netkit-api:latest python /app/mcp/server.py
```

Docker actually executed:
```bash
python /app/api/api.py python /app/mcp/server.py
# ENTRYPOINT args are PREPENDED, not replaced!
```

### Solution
Changed `Dockerfile` line 86 from `ENTRYPOINT` to `CMD`:

```dockerfile
CMD ["python", "/app/api/api.py"]  # CORRECT
```

**Docker Behavior**:
- `ENTRYPOINT`: User arguments are **appended** to the entrypoint
- `CMD`: User arguments **replace** the CMD entirely

Now when running MCP server:
```bash
docker run ... python /app/mcp/server.py
# Correctly executes: python /app/mcp/server.py
```

**Files Modified**: `Dockerfile` (line 86)

---

## Bug 3: SSH ControlMaster Socket Error

### Problem
SSH connections failed when `.ssh` directory was mounted read-only (`:ro`):

**Error Message**:
```
unix_listener: cannot bind to path /home/runner/.ssh/cm-dev@156.67.24.79:22.reeR92Z28IqWb0Uk: Read-only file system
```

### Root Cause
User's `~/.ssh/config` had ControlMaster enabled, which creates socket files in `.ssh/` for connection reuse. Container couldn't write these sockets because mount was read-only.

### Why Not Make It Read-Write?
❌ **Bad Solution**: Change mount to `:rw`
- Security risk: container could modify private keys
- Security risk: container could alter SSH config
- Violates principle of least privilege

### Solution
✅ **Good Solution**: Disable ControlMaster in the container

Added SSH options to `executors.py` `SSHExecutor.EPHEMERAL_DEFAULTS`:

```python
EPHEMERAL_DEFAULTS = [
    "-o", "BatchMode=yes",
    "-o", "UserKnownHostsFile=/dev/null",
    "-o", "StrictHostKeyChecking=no",
    "-o", "CheckHostIP=no",
    "-o", "LogLevel=ERROR",
    "-o", "ControlMaster=no",  # NEW: Disable ControlMaster
    "-o", "ControlPath=none",  # NEW: No control sockets
]
```

**Benefits**:
- `.ssh` directory stays read-only and secure
- SSH still works perfectly (ControlMaster is just an optimization)
- No security compromise
- No socket file creation needed

**Files Modified**: `executors.py` (SSHExecutor class)

---

## Documentation Improvements

### README.md - MCP Server Section

Added comprehensive MCP integration documentation:

1. **Claude Desktop Configuration Section**
   - Platform-specific config file locations (macOS/Windows/Linux)
   - Complete JSON configuration example
   - Step-by-step setup instructions

2. **Critical Warnings & Important Notes**
   - ⚠️ Use absolute paths (not `~`)
   - Network capabilities are optional (explains which tools need them)
   - SSH mount is optional (explains what it provides)
   - Whitelist/Blacklist are inline environment variables (not files)

3. **Minimal Configuration Example**
   - For users who only need basic tools (no capabilities)
   - Shows what works without advanced features

4. **Comprehensive Troubleshooting Section**
   - Tilde expansion error (with correct examples)
   - Permission denied errors (capability requirements)
   - SSH authentication failures (mount issues)
   - MCP connection failures (Docker/JSON issues)

5. **MCP Tools Documentation**
   - Listed all 15 tools with categories
   - Marked which tools require capabilities
   - Clarified tool availability

---

## Files Modified

| File | Changes | Lines |
|------|---------|-------|
| `README.md` | Added MCP Server section with config, troubleshooting, examples | ~150 lines added |
| `Dockerfile` | Changed ENTRYPOINT to CMD | Line 86 |
| `executors.py` | Added ControlMaster disable options to SSHExecutor | Lines 29-30 |
| `CLAUDE_CODE_NOTES.md` | Documented all bugs and fixes | Created |

---

## Testing Performed

### Before Fixes
- ❌ MCP server timeout (60s)
- ❌ HTTP API starting instead of MCP stdio
- ❌ Tilde expansion error in volume mount
- ❌ SSH ControlMaster socket errors

### After Fixes
- ✅ MCP server connects in <1 second
- ✅ Proper stdio communication (no HTTP server)
- ✅ Volume mounts work with absolute paths
- ✅ SSH works with read-only `.ssh` mount
- ✅ All 15 tools available in Claude Desktop

### Test Commands
```bash
# Test SSH functionality
ssh u whoami          # Should work (if whoami exists)
ssh pr0 id            # Alternative command for minimal systems

# Test DNS tools
dig google.com +short
host example.com

# Test network scanning (requires capabilities)
nmap -sT -p 80,443 scanme.nmap.org
```

---

## Impact & Deployment

### For Local Development
```bash
cd ~/Documents/projects/netkit-api
docker build -t flengure/netkit-api:latest .
# Restart Claude Desktop
```

### For Docker Hub Release
```bash
docker build -t flengure/netkit-api:latest .
docker tag flengure/netkit-api:latest flengure/netkit-api:v2.0.1
docker push flengure/netkit-api:latest
docker push flengure/netkit-api:v2.0.1
```

### For End Users
1. Pull updated image: `docker pull flengure/netkit-api:latest`
2. Update Claude Desktop config with absolute paths
3. Restart Claude Desktop
4. netkit-api should appear in available MCP servers

---

## Key Learnings for Claude Code

### Docker Best Practices
1. **Use `CMD` not `ENTRYPOINT` when you want command override**
   - `CMD`: User args replace defaults
   - `ENTRYPOINT`: User args append to entrypoint
   - Use `ENTRYPOINT` + `CMD` together for wrapper scripts with default args

2. **JSON configs don't expand shell variables**
   - `~` doesn't expand to home directory
   - `$HOME` doesn't work either
   - Always use absolute paths in JSON

3. **Mount permissions matter**
   - Use `:ro` (read-only) when possible for security
   - Only use `:rw` when container must write data
   - Consider tmpfs for writable temporary data

### SSH in Containers
1. **ControlMaster requires writable directory**
   - Creates socket files for connection reuse
   - Not essential for functionality, just optimization
   - Can be disabled with SSH options

2. **Read-only mounts are preferred**
   - Prevents container from modifying sensitive files
   - SSH keys should never be writable by containers
   - SSH config should never be modified by containers

### MCP Server Development
1. **stdio transport uses stdin/stdout**
   - Don't start HTTP servers in MCP mode
   - Don't print debug logs to stdout (use stderr)
   - Use newline-delimited JSON (JSON-RPC 2.0)

2. **Error messages are critical**
   - Timeout errors often mean server isn't responding
   - Check logs for "Starting server on port X" (wrong mode!)
   - stderr output appears in Claude Desktop logs

---

## Future Improvements

### Potential Enhancements
1. **File-based whitelist/blacklist support**
   - Add `CONFIG_DIR` environment variable
   - Load whitelist.txt and blacklist.txt from mounted directory
   - More user-friendly than inline environment variables

2. **Automated installer script**
   - Shell script to detect OS and set absolute paths
   - Handles `.ssh` mount configuration
   - Updates Claude Desktop config automatically

3. **Example configs repository**
   - Common use cases (pentesting, monitoring, basic DNS)
   - Different security postures (minimal, standard, advanced)
   - Platform-specific examples

4. **Better SSH error messages**
   - Detect when host doesn't have requested command
   - Suggest alternatives (whoami → id, ps aux → ps)
   - Better handling of BusyBox/minimal systems

---

## References

- Docker ENTRYPOINT vs CMD: https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact
- SSH ControlMaster: https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing
- MCP Protocol: https://modelcontextprotocol.io/docs/
- Claude Desktop Config: https://docs.claude.ai/docs/
